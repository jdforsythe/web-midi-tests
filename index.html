<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MIDI Test</title>
</head>
<body>
  <h2>Check the console</h2>
</body>

<!-- LaunchPad Mini Buttons -->
<script type="text/javascript">
const COMMANDS = {
  TopButtons: 0xb0, // 176
  OtherButtons: 0x90, // 144
};

const BUTTON_STATE = {
  Unpressed: 0,
  Pressed: 1,
};

const ALL_BUTTONS = (new Array(80)).fill(0)
  .map((_, i) => [i % 9, (i - i % 9) / 9])
  .map(([x, y]) => {
    return {
      cmd: y >= 8 ? COMMANDS.TopButtons : COMMANDS.OtherButtons,
      key: y >= 8 ? 0x68 + x : 0x10 * y + x,
      coords: [x, y],
    };
  });

const byXy = (x, y) => ALL_BUTTONS[9 * y + x];
</script>

<!-- letter on/off maps -->
<script type="text/javascript">
const LETTERS = {
  'C': [
    [0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 1, 0, 0, 0, 0],
    [0, 0, 1, 0, 1, 0, 0, 0],
    [0, 0, 1, 0, 0, 0, 0, 0],
    [0, 0, 1, 0, 0, 0, 0, 0],
    [0, 0, 1, 0, 1, 0, 0, 0],
    [0, 0, 0, 1, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0],
  ],

  'D': [
    [0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 1, 1, 0, 0, 0, 0],
    [0, 0, 1, 0, 1, 0, 0, 0],
    [0, 0, 1, 0, 1, 0, 0, 0],
    [0, 0, 1, 0, 1, 0, 0, 0],
    [0, 0, 1, 0, 1, 0, 0, 0],
    [0, 0, 1, 1, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0],
  ],

  'E': [
    [0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 1, 1, 1, 0, 0, 0],
    [0, 0, 1, 0, 0, 0, 0, 0],
    [0, 0, 1, 1, 1, 0, 0, 0],
    [0, 0, 1, 0, 0, 0, 0, 0],
    [0, 0, 1, 0, 0, 0, 0, 0],
    [0, 0, 1, 1, 1, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0],
  ],

  'G': [
    [0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 1, 1, 0, 0, 0],
    [0, 0, 1, 0, 0, 0, 0, 0],
    [0, 0, 1, 0, 1, 1, 0, 0],
    [0, 0, 1, 0, 0, 1, 0, 0],
    [0, 0, 1, 0, 0, 1, 0, 0],
    [0, 0, 0, 1, 1, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0],
  ],

  'N': [
    [0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 1, 0, 0, 1, 0, 0],
    [0, 0, 1, 1, 0, 1, 0, 0],
    [0, 0, 1, 1, 0, 1, 0, 0],
    [0, 0, 1, 0, 1, 1, 0, 0],
    [0, 0, 1, 0, 1, 1, 0, 0],
    [0, 0, 1, 0, 0, 1, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0],
  ],

  'O': [
    [0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 1, 0, 0, 0, 0],
    [0, 0, 1, 0, 1, 0, 0, 0],
    [0, 0, 1, 0, 1, 0, 0, 0],
    [0, 0, 1, 0, 1, 0, 0, 0],
    [0, 0, 1, 0, 1, 0, 0, 0],
    [0, 0, 0, 1, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0],
  ],

  'S': [
    [0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 1, 0, 0, 0, 0],
    [0, 0, 1, 0, 1, 0, 0, 0],
    [0, 0, 1, 0, 0, 0, 0, 0],
    [0, 0, 0, 1, 0, 0, 0, 0],
    [0, 0, 0, 0, 1, 0, 0, 0],
    [0, 0, 1, 0, 1, 0, 0, 0],
    [0, 0, 0, 1, 0, 0, 0, 0],
  ],

  'T': [
    [0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 1, 1, 1, 0, 0, 0],
    [0, 0, 0, 1, 0, 0, 0, 0],
    [0, 0, 0, 1, 0, 0, 0, 0],
    [0, 0, 0, 1, 0, 0, 0, 0],
    [0, 0, 0, 1, 0, 0, 0, 0],
    [0, 0, 0, 1, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0],
  ],

  'U': [
    [0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 1, 0, 0, 1, 0, 0],
    [0, 0, 1, 0, 0, 1, 0, 0],
    [0, 0, 1, 0, 0, 1, 0, 0],
    [0, 0, 1, 0, 0, 1, 0, 0],
    [0, 0, 1, 0, 0, 1, 0, 0],
    [0, 0, 0, 1, 1, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0],
  ],

  'W': [
    [0, 0, 0, 0, 0, 0, 0, 0],
    [0, 1, 0, 0, 0, 1, 0, 0],
    [0, 1, 0, 0, 0, 1, 0, 0],
    [0, 1, 0, 1, 0, 1, 0, 0],
    [0, 1, 0, 1, 0, 1, 0, 0],
    [0, 1, 0, 1, 0, 1, 0, 0],
    [0, 0, 1, 0, 1, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0],
  ],

  'Y': [
    [0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 1, 0, 1, 0, 0, 0],
    [0, 0, 1, 0, 1, 0, 0, 0],
    [0, 0, 0, 1, 0, 0, 0, 0],
    [0, 0, 0, 1, 0, 0, 0, 0],
    [0, 0, 0, 1, 0, 0, 0, 0],
    [0, 0, 0, 1, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0],
  ],

  'OFF': [
    [0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0],
    [0, 0, 0, 0, 0, 0, 0, 0],
  ],
};
</script>

<!-- display -->
<script type="text/javascript">
const BRIGHTNESS = {
  Off: 0,
  Low: 1,
  Medium: 2,
  High: 3,
};

const COLORS = {
  Red: 0,
  Green: 1,
  Amber: 2,
  Yellow: 3,
}

const LED_VALUES = {
  [COLORS.Red]: (brightness) => ({ red: brightness, green: 0 }),
  [COLORS.Green]: (brightness) => ({ red: 0, green: brightness }),
  [COLORS.Amber]: (brightness) => ({ red: brightness, green: brightness }),
  [COLORS.Yellow]: (brightness) => brightness ? ({ red: 2, green: 3 }) : { red: 0, green: 0 },
}

function getColorMidiCode(brightness, color) {
  const { red, green } = LED_VALUES[color](brightness);

  return (
    0b10000 * green +
    0b01000 * 0 + // clear bit
    0b00100 * 0 + // copy bit
    0b00001 * red
  );
}

function getLedMap(onOffMap, colorMap) {
  const ledMap = [];

  for (let i = 0; i < onOffMap.length; i++) {
    const rowOnOff = onOffMap[i];
    const rowColor = colorMap[i];

    const row = [];

    for (let j = 0; j < rowOnOff.length; j++) {
      const buttonOnOff = rowOnOff[j];
      const buttonColor = rowColor[j];
      const btn = byXy(j, i);

      if (!buttonOnOff) {
        row.push(undefined);

        continue;
      }

      row.push([btn.cmd, btn.key, getColorMidiCode(BRIGHTNESS.High, buttonColor)]);

    }

    ledMap.push(row);
  }

  return ledMap;
}

function resetLaunchPad(midiOutput) {
  midiOutput.send([0xb0, 0x00, 0x00]);
}

function displayLedMap(midiOutput, ledMap) {
  for (const row of ledMap) {
    for (const button of row) {
      if (button) {
        midiOutput.send(button);
      }
    }
  }
}

function displayLetter(midiOutput, letter, colorMap) {
  resetLaunchPad(midiOutput);

  const letterToGet = letter === ' '  ? 'OFF' : letter.toUpperCase();

  const ledMap = getLedMap(LETTERS[letterToGet], colorMap);

  displayLedMap(midiOutput, ledMap);
}
</script>

<!-- main execution -->
<script type="text/javascript">
async function getMarqueePromise(midiOutput) {
  const colors = [
    [[COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red]],
    [[COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red]],
    [[COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red]],
    [[COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red]],
    [[COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red]],
    [[COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red]],
    [[COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red]],
    [[COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red], [COLORS.Red]],
  ];

  const letters = ['C', 'O', 'D', 'E', ' ', 'Y', 'O', 'U', 'N', 'G', 'S', 'T', 'O', 'W', 'N', 'OFF'];

  let retn = Promise.resolve();

  for (const letter of letters) {
    retn = retn.then(() => new Promise((resolve) => setTimeout(resolve, 500)))
      .then(() => displayLetter(midiOutput, letter, colors));
  }

  return retn;
}

navigator.requestMIDIAccess().then((midiAccess) => {
  const output = midiAccess.outputs.values().next().value;

  return getMarqueePromise(output);
});
</script>

</html>
